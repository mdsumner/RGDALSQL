---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-"
)
```

[![Travis-CI Build Status](https://travis-ci.org/mdsumner/RGDALSQL.svg?branch=master)](https://travis-ci.org/mdsumner/RGDALSQL)
[![Coverage Status](https://img.shields.io/codecov/c/github/mdsumner/RGDALSQL/master.svg)](https://codecov.io/github/mdsumner/RGDALSQL?branch=master)


## RGDALSQL

WIP

```{r}
library(RGDALSQL)
f = system.file("extdata/continents", package = "RGDALSQL")
db <- dbConnect(RGDALSQL::GDALSQL(), f)
dbSendQuery(db, "SELECT * FROM continent WHERE FID < 1")


dbSendQuery(db, "SELECT * FROM continent WHERE continent LIKE '%ca'")

res <- dbReadTable(db, "continent")
print(res)
substr(head(res$GEOM), 1, 200)
```

Geometry currently is just in JSON form. See hypertidy/vapour for the tooling. 


Lazy does not work yet ...


```{r}
library(dplyr)
tbl(db, "continent") %>% dplyr::filter(continent == "Australia")

library(sf)
to_sf <- function(x, ...) {
  x[["GEOM"]] <- sf::st_as_sfc(x[["GEOM"]], GeoJSON = TRUE)
  sf::st_as_sf(x)
}
tbl(db, "continent") %>% dplyr::filter(continent %in% c("Australia", "Antarctica")) %>% collect() %>% 
  to_sf()
```

Try OSM PBF. 

```{r}
f <- "~/albania-latest.osm.pbf"
pbf <- dbConnect(RGDALSQL::GDALSQL(),f)
## we have to use a normalized path 
## (vapour doesn't do this yet, but GDALSQL will do it *when connecting*, 
## currently maintains the input DSN)
pbf
# db_list_tables(pbf)

tbl(pbf, "points") 
```


```{r}
f <- "inst/extdata/shapes.gpkg"
conn <- dbConnect(RGDALSQL::GDALSQL(),f)
conn
dbListTables(conn)

x <- dbSendQuery(conn, "SELECT AREA FROM sids WHERE SID74 < 10")
```
